# =============================================================================
# Kamal 2.x Deploy Configuration - JustJeeps API Backend
# =============================================================================

service: justjeeps-api

image: ricardotassionunchi/justjeeps-api

# =============================================================================
# SERVIDORES
# =============================================================================
servers:
  web:
    hosts:
      - 138.197.173.222
    labels:
      traefik.http.routers.justjeeps-api.rule: Host(`orderapi.nunchisolucoes.com`)
      traefik.http.routers.justjeeps-api-secure.entrypoints: websecure
      traefik.http.routers.justjeeps-api-secure.rule: Host(`orderapi.nunchisolucoes.com`)
      traefik.http.routers.justjeeps-api-secure.tls: true
      traefik.http.routers.justjeeps-api-secure.tls.certresolver: letsencrypt
    options:
      memory: 2g
      cpus: 1

# =============================================================================
# PROXY (Traefik)
# =============================================================================
proxy:
  ssl: true
  host: orderapi.nunchisolucoes.com
  app_port: 8080
  healthcheck:
    path: /api/health
    interval: 3
    timeout: 30

# =============================================================================
# REGISTRY
# =============================================================================
registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# =============================================================================
# VARIAVEIS DE AMBIENTE
# =============================================================================
env:
  clear:
    PORT: 8080
    NODE_ENV: production
    ENABLE_AUTH: "true"
    JWT_EXPIRES_IN: 24h
    PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
    PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
  secret:
    # Database & Auth
    - DATABASE_URL
    - JWT_SECRET
    # Magento
    - MAGENTO_KEY
    # Keystone
    - KEYSTONE_KEY
    - KEYSTONE_ACCOUNT
    - KEYSTONE_ACCOUNT_DS
    - KEYSTONE_KEY_DS
    - KEYSTONE_FTP_USER
    - KEYSTONE_FTP_PASS
    # Meyer
    - MEYER_USERNAME
    - MEYER_PASSWORD
    - MEYER_KEY
    # Turn14
    - TURN14_CLIENT_ID
    - TURN14_CLIENT_SECRET
    - TURN14_ENVIRONMENT
    # Premier
    - PREMIER_API_KEY
    - PREMIER_BASE_URL
    # WheelPros
    - WHEELPROS_USER
    - WHEELPROS_PASS
    # Other APIs
    - PARSEHUB_KEY_NORTHRIDGE
    - FREIGHTCOM_API_KEY
    # Axiom (Error Monitoring)
    - AXIOM_TOKEN
    - AXIOM_DATASET

# =============================================================================
# SSH
# =============================================================================
ssh:
  user: root

# =============================================================================
# BUILDER
# =============================================================================
builder:
  arch: amd64
  dockerfile: Dockerfile.production
  context: .
